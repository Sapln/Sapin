#include<stdio.h>
#include<stdlib.h>
#include<SDL.h>
#include<SDL_types.h>
#include<time.h>
#include<string.h>

typedef struct position{
  int x;
  int y;
}position;

typedef struct player{
  position pos;
}player;

#define LC 32



SDL_Surface * ecran = NULL;

//void gauche();
SDL_Event pause();
void trouvePerso(char ** TJeu,int ,int,position * perso,char* caseInit);
void afficheTab2D(char **, int ,int);
void deplacement(char** TJeu,int,int);

int main(){
  int hauteur = 4;
  int largeur =7;
  int i,j;
  int WIDTH =  largeur * LC;
  int HEIGHT= hauteur * LC;
  if(SDL_Init(SDL_INIT_VIDEO) == 1){
    fprintf(stderr,"Erreur SDL : %s\n",SDL_GetError());
    return -1;
  }

  if(( ecran = SDL_SetVideoMode(WIDTH,HEIGHT,32,SDL_HWSURFACE)) == NULL){
    fprintf(stderr,"Erreur VideoMode : %s\n",SDL_GetError());
    exit(EXIT_FAILURE);}

  char** TJeu =(char**) malloc(largeur*sizeof(char*));
  for(i=0; i<largeur;i++){
  TJeu[i]=   (char*) malloc((hauteur+1)*sizeof(char));
  }
  for(i = 0; i < largeur; i++)
  {
    for(j = 0; j < hauteur; j++)
    {
       TJeu[i][j]=' ';
    }
    TJeu[i][2]='#';
  }
  TJeu[3][3]='P';
  TJeu[2][2]='I';

  
  deplacement(TJeu,hauteur,largeur);
  SDL_Quit();
  free(TJeu);
  
  return 0;}

void trouvePerso(char ** TJeu,int hauteur,int largeur,position * perso,char* caseInit){
  // position perso;
  perso->x=0;
  perso->y=0;
  
  int i,j;
  for(i = 0; i < largeur; i++)
  {
    for(j = 0; j < hauteur; j++)
      {
        if(TJeu[i][j]=='p' || TJeu[i][j]=='P'){
	  perso->x = j;
	  perso->y = i;
	}
      }
  }
  caseInit=&TJeu[perso->y][perso->x];
  //printf("position=%d %d\n",perso->x,perso->y);
}
    

void afficheTab2D(char ** tab, int hauteur,int largeur)
{
  int i,j;
  for(i = 0; i < hauteur; i++)
  {
    printf("\n");
    for(j = 0; j < largeur; j++)
    {
      printf("%c  ", tab[j][i]);
    }
    printf("\n");
  }
  printf("\n");
}


	
SDL_Event pause(){
  // printf("oijio");
  int cont=1;
  SDL_Event event;
  while( cont){
    SDL_WaitEvent(&event);
    switch(event.type){
    case SDL_QUIT:
      cont=0;
      break;
    case SDL_KEYDOWN:
      cont=0;
      break;
    default:
      cont=1;
    }
  }
  return(event);
}

void deplacement(char** TJeu,int hauteur,int largeur){
  int cont=1 ;
  char* change= (char*) malloc((hauteur+1)*sizeof(char));
  SDL_Event event ;
  position perso;
  position posPrev;
  char nouvCase;
  char exCase;
  
  trouvePerso(TJeu,hauteur,largeur,&perso,&nouvCase);
  afficheTab2D(TJeu,hauteur,largeur);
  while(cont){
    posPrev= perso;
    exCase=nouvCase;
    printf("position=%d %d\n",perso.x,perso.y);
    printf("position=%d %d\n",posPrev.x,posPrev.y);
    event= pause();
    
    switch(event.type){
    case SDL_QUIT:
      cont=0;
    case SDL_KEYDOWN:
      switch(event.key.keysym.sym){
      case SDLK_UP:
	if(perso.y>0){
	  if( TJeu[perso.x][perso.y-1] == 'I'){
	    perso.y--;
	    nouvCase='p';
	  }
	  else if(TJeu[perso.x][perso.y-1] == ' '){
	  
	  perso.y--;
	  nouvCase='P';
	  }
	}
      
	break ;
      case SDLK_DOWN:
	if(perso.y<hauteur-1){
	  if( TJeu[perso.x][perso.y +1] == 'I'){
	    perso.y++;
	    nouvCase='p';}
	  else if(TJeu[perso.x][perso.y +1] == ' '){
	    perso.y++;
	    nouvCase='P';
	  }
	}
	break ;
	
      case SDLK_LEFT :
	if(perso.x>0){
	  if( TJeu[perso.x -1][perso.y] == 'I'){
	    
	    perso.x--;
	    nouvCase='p';}
	  
	  else if(TJeu[perso.x-1][perso.y] == ' '){
	  perso.x--;
	    nouvCase='P';
	  }
	}
	//dessine(ecran);
	break ;
      case SDLK_RIGHT:
	if(perso.x<largeur-1){
	  if( TJeu[perso.x +1][perso.y] == 'I'){
	    perso.x++;
	    nouvCase='p';}
	  else if(TJeu[perso.x+1][perso.y] == ' '){
	    perso.x++;
	    nouvCase='P';
	  }
	}
	break ;
      case 'q':
	cont=0 ;
	break ;
      }
    }

    if(exCase =='P'){
      exCase=' ';}
    else{
      exCase='I';}
    
    
    strcpy(change,TJeu[posPrev.x]);
    change[posPrev.y]=exCase;  
    strcpy(TJeu[posPrev.x],change);

    
    strcpy(change,TJeu[perso.x]);
    change[perso.y]=nouvCase;  
    strcpy(TJeu[perso.x],change);

    
    afficheTab2D(TJeu,hauteur,largeur);
  }

}

